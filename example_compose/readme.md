# Example Compose

This example demonstrates the use of the logging and log processing scripts within a Docker Compose environment. The setup includes a service that generates logs using `structlog` and a log processor that captures and stores these logs in an SQLite database.

## Prerequisites

- Docker and Docker Compose
- Python 3.6 or higher

## Setup

1. **Clone the repository**:
    ```sh
    git clone https://github.com/yourusername/logger.git
    cd ./example_compose
    ```

2. **Build and run the Docker Compose services**:
    ```sh
    docker-compose up --build
    ```

3. **Run the log processor**:
    The `log_processor.py` script is meant to be run from the Docker host and is located in the `../log_processor` folder relative to this directory. Navigate to the [log_processor] folder and run the script:
    ```sh
    cd ../log_processor
    python log_processor.py
    ```

    Output will be a new logs.db file displaying the structured logs generated by the logger service.

## Services

### Logger Service

The `logger_service` runs the [test_logger.py] script in a loop, generating logs every 5 seconds. The logs are structured using `structlog` and include various log levels (INFO, DEBUG, WARNING, ERROR, CRITICAL).

### Log Processor

The `log_processor.py` script tails the logs from the `logger_service`, processes them, and stores them in an SQLite database (`logs.db`). The logs are stored in two tables: `structured_logs` and `unstructured_logs`. A timestamp is stored in a timestamp table to mark the last processed log for tailing purposes (retrieving logs after the last processed timestamp).

## Expected Output

### Structured Logs Table

The `structured_logs` table will contain the structured logs generated by the `logger_service`. Each row includes detailed fields such as `timestamp`, `service`, `log_level`, `message`, `correlation_id`, `caller_module`, `caller_function`, `function_kwargs`, and `custom_fields`.

#### Example Rows

| id  | timestamp           | service         | log_level | message                           | correlation_id                        | caller_module | caller_function  | function_kwargs                                                                 | custom_fields                                                                 |
|-----|---------------------|-----------------|-----------|-----------------------------------|---------------------------------------|---------------|------------------|--------------------------------------------------------------------------------|-------------------------------------------------------------------------------|
| 1   | 2024-12-25T00:04:04Z| logger_service  | info      | Info log from example_function    | 123e4567-e89b-12d3-a456-426614174000  | __main__      | example_function | {"param1": "value1", "param2": "value2", "optional_param": "optional_value"}   | {"custom_key": "custom_value"}                                                |
| 2   | 2024-12-25T00:04:09Z| logger_service  | debug     | Debug log from example_function   | 123e4567-e89b-12d3-a456-426614174000  | __main__      | example_function | {"param1": "value1", "param2": "value2", "optional_param": "optional_value"}   | {"custom_key": "custom_value"}                                                |
| 3   | 2024-12-25T00:04:14Z| logger_service  | warning   | Warning log from example_function | 123e4567-e89b-12d3-a456-426614174000  | __main__      | example_function | {"param1": "value1", "param2": "value2", "optional_param": "optional_value"}   | {"custom_key": "custom_value"}                                                |
| 4   | 2024-12-25T00:04:19Z| logger_service  | error     | Error log from example_function   | 123e4567-e89b-12d3-a456-426614174000  | __main__      | example_function | {"param1": "value1", "param2": "value2", "optional_param": "optional_value"}   | {"custom_key": "custom_value"}                                                |
| 5   | 2024-12-25T00:04:24Z| logger_service  | critical  | Critical log from example_function| 123e4567-e89b-12d3-a456-426614174000  | __main__      | example_function | {"param1": "value1", "param2": "value2", "optional_param": "optional_value"}   | {"custom_key": "custom_value"}                                                |

### Unstructured Logs Table

The `unstructured_logs` table is intended to store logs that do not follow the structured format. However, in this example, all logs are structured, so this table will remain empty.

## Files

### `docker-compose.yml`

Defines the services and their configurations.

```yaml
version: '3.8'

services:
  logger_service:
    build: .
    container_name: logger_service
    volumes:
      - .:/app
    command: >
      sh -c "
      while true; do
        python /app/test_logger.py;
        sleep 5;
      done"